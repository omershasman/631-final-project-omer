---
title: "final_project_draft"
author: "Omer Shasman"
date: "5/3/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introduction
On Time Performance analysis of an airline network - This is an important metric for the airline that is calculated as the percentage of flights which are delayed by more than 14 minutes while the aircraft arrives at the gate. There are multiple reasons which contribute to the variation in OTP. An analysis of the OTP metric breaking it down into its individual components namely different delay and historical delays can provide insights into how the OTP for an airline can be managed by operational/process changes. The Department of Transport releases the flight level, On Time Performance data. This dataset also has various other factors which affect the Arrival Delay of a flight. An exploratory analysis of this data with the Arrival Delay as the response variable analyzed against different dimensions provided in the dataset can reveal several insights to improve the OTP of an Airline.

## What
As part of my Final Project, I am planning to use a subset of OTP data to perform analysis of delays on actual file arrivals focusing on one particular Station and Airline. Since airline operations are very complex, the arrival delays itself can be due to varying factors, like weather delay, carrier delays, security delays, Late aircraft delay...etc or any combinations of any of these in general. My focus is only on 2 types of delays so that I can minimize the complexities in data structures and limit any repeating processes or steps, and rather focus on how to manipulate and do analysis/inference with few variables. Hence I will be considering only 5 years data ranging from year 2014 till 2019 two types of delays "Weather Delays" and "Carrier Delays" 

## Why
I thought airline is an interesting business with lot of complex operation/data and business itself is most of us are familiar with. Also, with the time constraint we have, there were few sites like [Kaggle](https://www.kaggle.com/datasets/yuanyuwendymu/airline-delay-and-cancellation-data-2009-2018?select=2014.csv)  and [DOT On-Time_performance](https://www.transtats.bts.gov/databases.asp?f7owrp6_VQ=G&f7owrp6_Qr5p=cn55r0tr4%FDg4n8ry&Z1qr_VQF=D)

This data is presented as yearly file in csv format, I have to merge different years data using dply bind command to append rows at the end and build one file.

## How
Use RMarkdown and explore Rfunctions that can integrate some of the topics we learned in the class for flight arrival delay analysis. The following are steps which will be followed as part of the project

- Load data into R Markdown using R chunks
- Merge Data using ddplyr 
- Filter/melt/massage data using Tidy Data approach
- Use sampling strategy for identifying sample observations.
- Use Stats function to determine mean, median, IQR,...
- Regression - Find any co-relation between total flights arriving at a particualr airport and  delays to identify if it's the airport operational/capacity issue or not.
- Could hosted data and R Markdown interface. Pull data from AWS S3 buckets than loading from local machine.

# Body
This project perform analysis of flight arrival delays focusing on one particular Station and Airline.
Since airline delays are unavoidable there is always a chance that a particualr flight will be delayed. I think this analysis can be used to further study on why a particular delay happens and if the process/schedule/operations can be enhanced or refined to minimize the delay risk in future flights. 

# Packages Required
```{r}
library(knitr) ##for printing tables in R Markdown
library(dplyr) ##for data munging
library(ggplot2) ## for charts
library('infer') ## for rep_sample_n used for clustered sampling
library("lubridate")
```


```{r Load data into R Markdown using R chunks}
library(readr)
flight.data.y2014 <- read_csv("Data/2014.csv")
head(flight.data.y2014)

flight.data.y2015 <- read_csv("Data/2015.csv")
head(flight.data.y2015)

flight.data.y2016 <- read_csv("Data/2016.csv")
head(flight.data.y2016)

flight.data.y2017 <- read_csv("Data/2017.csv")
head(flight.data.y2017)

flight.data.y2018 <- read_csv("Data/2018.csv")
head(flight.data.y2018)

# Since this is a large dataset, sampling/manipualting on all the observations is throwing memory error in my machine. So for ease of processing, I am considering a subset of data with arrival as MSP.
flight.data.y2014 <- flight.data.y2014[flight.data.y2014$DEST %in% 'MSP', ]
flight.data.y2015 <- flight.data.y2015[flight.data.y2015$DEST %in% 'MSP', ]
flight.data.y2016 <- flight.data.y2016[flight.data.y2016$DEST %in% 'MSP', ]
flight.data.y2017 <- flight.data.y2017[flight.data.y2017$DEST %in% 'MSP', ]
flight.data.y2018 <- flight.data.y2018[flight.data.y2018$DEST %in% 'MSP', ]
```

```{r Merge Data using ddplyr }
# Combine the 5 vectors to a single vector
flight.data.y2014.y2018 <- dplyr::bind_rows(flight.data.y2014,flight.data.y2015,flight.data.y2016,flight.data.y2017,flight.data.y2018,)

# replace all na in the fields we interested in to 0
flight.data.y2014.y2018$ARR_DELAY <- flight.data.y2014.y2018$ARR_DELAY %>% replace(is.na(.), 0)

flight.data.y2014.y2018$LATE_AIRCRAFT_DELAY <- flight.data.y2014.y2018$LATE_AIRCRAFT_DELAY %>% replace(is.na(.), 0)
flight.data.y2014.y2018$SECURITY_DELAY <- flight.data.y2014.y2018$SECURITY_DELAY %>% replace(is.na(.), 0)
# flight.data.y2014.y2018$NAS_DELAY <- flight.data.y2014.y2018$NAS_DELAY %>% replace(is.na(.), 0)
flight.data.y2014.y2018$WEATHER_DELAY <- flight.data.y2014.y2018$WEATHER_DELAY %>% replace(is.na(.), 0)
flight.data.y2014.y2018$CARRIER_DELAY <- flight.data.y2014.y2018$CARRIER_DELAY %>% replace(is.na(.), 0)
hist(flight.data.y2014.y2018$FL_DATE, flight.data.y2014.y2018$ARR_DELAY, breaks = 100)
summary(flight.data.y2014.y2018)

# colnames(flight.data.y2014.y2018)
```

```{r}
flight.data.y2014.y2018.delay <- flight.data.y2014.y2018[flight.data.y2014.y2018$CARRIER_DELAY > 800, ]
summary(flight.data.y2014.y2018.delay)
plot(flight.data.y2014.y2018.delay$AIR_TIME, flight.data.y2014.y2018.delay$CARRIER_DELAY)
```


# Topics From Class

## Topic 1:
R Markdown - I will be presenting the project in R Markdown and knit the file to a pdf document. Will be using R chunks to demonstrate and build the project components. 

## Topic 2:
GitHub - Will host the project in github repository for others to view my project components. 

## Topic 3:
Sampling strategies for an Observational study - Will be using sampling strategies - Simple random sampling, Strtified sampling, Cluster sampling and multistage sampling to group the data together by using different variables from the dataset and then use one of the sampling result to build topic#4 and 5.

```{r Sampling_Strategy - Simple sampling}
simple.sampling <- dplyr::sample_n(flight.data.y2014.y2018, 10000, replace=FALSE)
View(simple.sampling)
```

```{r Sampling_Strategy - Stratified sampling}
# Here I am making a cluster of where Airline code is the strata
DL <- flight.data.y2014.y2018[flight.data.y2014.y2018$OP_CARRIER %in% 'DL', ]
UA <- flight.data.y2014.y2018[flight.data.y2014.y2018$OP_CARRIER %in% 'UA',]
AA <- flight.data.y2014.y2018[flight.data.y2014.y2018$OP_CARRIER %in% 'AA',]
WN <- flight.data.y2014.y2018[flight.data.y2014.y2018$OP_CARRIER %in% airline,]

stratified.sampling <- dplyr::sample_n((UA), 10000, replace=FALSE)
dim(stratified.sampling)
```

```{r Sampling_Strategy - Clustered sampling}
# cluister1 <- dplyr::sample_n((flight.data.y2014.y2018), 10000, replace=FALSE)
# cluister2 <- dplyr::sample_n((flight.data.y2014.y2018), 10000, replace=FALSE)
# cluister3 <- dplyr::sample_n((flight.data.y2014.y2018), 10000, replace=FALSE)
dim(flight.data.y2014.y2018)
#randomly choose 4 10 groups out of the n
clusters <- sample(unique(flight.data.y2014.y2018$OP_CARRIER), size=10, replace=FALSE)

#define sample as all members who belong to one of the 10 operated carriers
clustered_by_op_carrier <- all_years[flight.data.y2014.y2018$OP_CARRIER %in% clusters, ]

#view how many observations came from each tour
table(clustered_by_op_carrier$OP_CARRIER)
clustered_by_op_carrier

```


## Topic 4:
Detailing Summary statistics ( Min. , 1st Qu., Median, Mean, 3rd Qu., Max.) of a variable and plotting graphs using ggplot2


```{r CARRIER_DELAY - Years 2014-2028}
# First select the sub-vectors which contains only he coulums we are interested in
carrier_delay_by_op_carrier <- clustered_by_op_carrier %>% select(c(FL_DATE, OP_CARRIER, CARRIER_DELAY)) %>% filter(OP_CARRIER == 'DL') %>%  filter(CARRIER_DELAY > 0) 
carrier_delay_by_op_carrier
hist(carrier_delay_by_op_carrier$FL_DATE, carrier_delay_by_op_carrier$CARRIER_DELAY, breaks = 100, col="lightblue")
```

```{r CARRIER_DELAY - Months in 2016}
# In 2016 we have a increase in delay. Let's find out month by analysis to approximate on which month in 2016 we have this issue.
carrier_delay_by_op_carrier_2016 <- carrier_delay_by_op_carrier
carrier_delay_by_op_carrier_2016$YEAR <- format(carrier_delay_by_op_carrier$FL_DATE, "%Y")
carrier_delay_by_op_carrier_2016 <- carrier_delay_by_op_carrier_2016 %>% filter(YEAR == '2016')
carrier_delay_by_op_carrier_2016$MONTH <- format(carrier_delay_by_op_carrier_2016$FL_DATE, "%m")
hist(carrier_delay_by_op_carrier_2016$FL_DATE, carrier_delay_by_op_carrier_2016$CARRIER_DELAY, breaks =200, col="lightgreen")

```
```{r CARRIER_DELAY - Day in Aug2016}
carrier_delay_by_op_carrier_2016_AUG <- carrier_delay_by_op_carrier_2016
carrier_delay_by_op_carrier_2016_AUG <- carrier_delay_by_op_carrier_2016_AUG %>% filter(MONTH == '08')
carrier_delay_by_op_carrier_2016_AUG$DAY <- format(carrier_delay_by_op_carrier_2016_AUG$FL_DATE, "%d")
hist(carrier_delay_by_op_carrier_2016_AUG$FL_DATE, carrier_delay_by_op_carrier_2016_AUG$CARRIER_DELAY, breaks =40, col="orange")
summary(carrier_delay_by_op_carrier_2016_AUG$CARRIER_DELAY)
```


## WEATHER DELAY
```{r WEATHER DELAY - Years 2014-2028}
# First select the sub-vectors which contains only he coulums we are interested in
weather_delay_by_op_carrier <- clustered_by_op_carrier %>% select(c(FL_DATE, OP_CARRIER, WEATHER_DELAY)) %>% filter(OP_CARRIER == 'DL') %>%  filter(WEATHER_DELAY > 0) 
weather_delay_by_op_carrier
hist(weather_delay_by_op_carrier$FL_DATE, weather_delay_by_op_carrier$WEATHER_DELAY, breaks = 100, col="lightblue")
```

```{r WEATHER DELAY - Months in 2016}
# In 2016 we have a increase in delay. Let's find out month by analysis to approximate on which month in 2016 we have this issue.
weather_delay_by_op_carrier_2016 <- weather_delay_by_op_carrier
weather_delay_by_op_carrier_2016$YEAR <- format(weather_delay_by_op_carrier$FL_DATE, "%Y")
weather_delay_by_op_carrier_2016 <- weather_delay_by_op_carrier_2016 %>% filter(YEAR == '2016')
weather_delay_by_op_carrier_2016$MONTH <- format(weather_delay_by_op_carrier_2016$FL_DATE, "%m")
hist(weather_delay_by_op_carrier_2016$FL_DATE, weather_delay_by_op_carrier_2016$weather_delay, breaks =200, col="lightgreen")

```
```{r WEATHER DELAY - Days in Dec2016}
weather_delay_by_op_carrier_2016_DEC <- weather_delay_by_op_carrier_2016 %>% filter(MONTH == '12')
weather_delay_by_op_carrier_2016_DEC$DAY <- format(weather_delay_by_op_carrier_2016_DEC$FL_DATE, "%d")
hist(weather_delay_by_op_carrier_2016_DEC$FL_DATE, weather_delay_by_op_carrier_2016_DEC$weather_delay, breaks =40, col="orange")
summary(weather_delay_by_op_carrier_2016_DEC$weather_delay)
```





```{r}
# weather_delay_by_op_carrier_2016 <- ifelse(weather_delay_by_op_carrier_2016$WEATHER_DELAY<0,0,weather_delay_by_op_carrier_2016$WEATHER_DELAY)
weather_delay_by_op_carrier_2016.gorupby <- flight.data.y2016 %>% select(c(FL_DATE, OP_CARRIER, WEATHER_DELAY)) %>% filter(OP_CARRIER == 'DL') %>% filter(WEATHER_DELAY > 0) %>% group_by(FL_DATE) %>% tally()
weather_delay_by_op_carrier_2016.gorupby

weather_delay_by_op_carrier_2017.gorupby <- flight.data.y2017 %>% select(c(FL_DATE, OP_CARRIER, WEATHER_DELAY)) %>% filter(OP_CARRIER == 'DL') %>% filter(WEATHER_DELAY > 0) %>% group_by(FL_DATE) %>% tally()
weather_delay_by_op_carrier_2017.gorupby

# month_delay_2015<- month_delay_2015[c(5,4,8,1,9,7,6,2,12,11,10,3),]
# weather_delay_by_op_carrier_2016.gorupby<- weather_delay_by_op_carrier_2016.gorupby[c(5,4,8,1,9,7,6,2,12,11,10,3),]
# 
# 
# month_Delay<-rbind(weather_delay_by_op_carrier_2016.gorupby, weather_delay_by_op_carrier_2017.gorupby)
month_Delay<-rbind(weather_delay_by_op_carrier_2016.gorupby)

month_Delay$YEAR <- month(month_Delay$FL_DATE)
month_Delay$MONTH <- year(month_Delay$FL_DATE)
month_Delay                            
ggplot(month_Delay, aes(x = MONTH, y = n, color = factor(MONTH), group = factor(YEAR))) +
geom_line() +
  labs(title="Total Flights Delayed across Months",y = 'Number of Delays',x = 'Months', fill='YEAR')
```



## Topic 5:
Regression (on if a particular type of delay has decreased over the time or not).


```{r}
# plot(flight.data.y2014.y2018$CARRIER_DELAY ~ length(flight.data.y2014.y2018$CARRIER_DELAY))
ggplot(data = flight.data.y2014.y2018, mapping = aes(x = FL_DATE, y = CARRIER_DELAY))+  # set data and axes mapping
  geom_point(color = "darkgreen", size = .5, alpha = 0.2)         # set static point aesthetics

```

# Conclusion
I designed this project as a way to review some of the topics we learned in the class/homework/assignments to reinforce some topics learned and also as an opportunity to refer back some of the materials. Hence I thought of picking a variety of topics like sampling strategies, summary statistics, ANOVA and regressions will be the best approach and most I can get from this project. If I have more time, I would have included some more topics (like binom, dbinom, geom...etc distributions) and see if my dataset have variables that can fit these distributions. Given only a academic background in statistics almost almost 20 years ago, I think this subject has given me much learning experience in statistics and I appreciate how these topics are applicable to find solutions in reality.


Access to aws s3 bucket
```{r}
library("aws.s3")
Sys.setenv(
  "AWS_ACCESS_KEY_ID" = "AKIAUTK5NLVJF67UNMH5",
  "AWS_SECRET_ACCESS_KEY" = "",
  "AWS_DEFAULT_REGION" = "us-east-1"
)
```

```{r}
bucketlist()
```

